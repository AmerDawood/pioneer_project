import 'dart:async';
import 'dart:io';

import 'package:flutter/material.dart';
import 'package:image_picker/image_picker.dart';
import 'package:pioneer_project/helpers/spacing.dart';
import 'package:pioneer_project/theming/colors.dart';
import 'package:pioneer_project/api/api_settings.dart';
import 'package:http/http.dart' as http;
import 'package:http_parser/http_parser.dart';
import 'dart:convert';

import '../../../models/initiativeOwnerRegisterRequest.dart';
import '../initiative-login/login_screen.dart';

class RegisterInitiativeOwnerScreen extends StatefulWidget {
  const RegisterInitiativeOwnerScreen({super.key});

  @override
  State<RegisterInitiativeOwnerScreen> createState() => _RegisterInitiativeOwnerScreenState();
}

class _RegisterInitiativeOwnerScreenState extends State<RegisterInitiativeOwnerScreen> {
  final _formKey = GlobalKey<FormState>();
  bool _isLoading = false;
  String? _errorMessage;

  // Organization details controllers
  final TextEditingController orgNameController = TextEditingController();
  final TextEditingController countryController = TextEditingController();
  final TextEditingController cityController = TextEditingController();
  final TextEditingController typeController = TextEditingController();
  final TextEditingController sectorController = TextEditingController();
  final TextEditingController sizeController = TextEditingController();
  final TextEditingController websiteController = TextEditingController();
  final TextEditingController foundedAtController = TextEditingController();

  // User details controllers
  final TextEditingController firstNameController = TextEditingController();
  final TextEditingController lastNameController = TextEditingController();
  final TextEditingController jobTitleController = TextEditingController();
  final TextEditingController emailController = TextEditingController();
  final TextEditingController passwordController = TextEditingController();
  final TextEditingController confirmPasswordController = TextEditingController();
  final TextEditingController languageController = TextEditingController();

  // Default language selection
  final List<String> languages = ['ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', 'English'];

  File? logoFile;

  @override
  void initState() {
    super.initState();
    // Set default language
    languageController.text = 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©';
  }

  @override
  void dispose() {
    // Dispose all controllers
    orgNameController.dispose();
    countryController.dispose();
    cityController.dispose();
    typeController.dispose();
    sectorController.dispose();
    sizeController.dispose();
    websiteController.dispose();
    foundedAtController.dispose();
    firstNameController.dispose();
    lastNameController.dispose();
    jobTitleController.dispose();
    emailController.dispose();
    passwordController.dispose();
    confirmPasswordController.dispose();
    languageController.dispose();
    super.dispose();
  }

  Future<void> _pickLogoImage() async {
    final picked = await ImagePicker().pickImage(source: ImageSource.gallery);
    if (picked != null) {
      setState(() {
        logoFile = File(picked.path);
      });
    }
  }

  Future<void> _selectDate(BuildContext context) async {
    final DateTime? picked = await showDatePicker(
      context: context,
      initialDate: DateTime.now(),
      firstDate: DateTime(1900),
      lastDate: DateTime.now(),
    );
    if (picked != null) {
      setState(() {
        foundedAtController.text = "${picked.year}-${picked.month}-${picked.day}";
      });
    }
  }

  Future<void> _submitForm() async {
    // Hide keyboard
    FocusScope.of(context).unfocus();

    // Reset error
    setState(() {
      _errorMessage = null;
    });

    if (_formKey.currentState!.validate()) {
      setState(() {
        _isLoading = true;
      });

      try {
        var uri = Uri.parse(
            'https://pioneer-project-2025.shop/api/register/initiative-owner');
        var request = http.MultipartRequest('POST', uri);

        // Add necessary headers
        request.headers['Accept'] = 'application/json';

        // Add all form fields with appropriate validation
        request.fields['org_name'] = orgNameController.text;
        request.fields['country'] = countryController.text;
        request.fields['city'] = cityController.text;
        request.fields['type'] = typeController.text;
        request.fields['sector'] = sectorController.text;

        // Fix for the size field - ensure it's within acceptable limits
        // Limit size to a short string that will fit in the database column
        String sizeValue = sizeController.text;
        if (sizeValue.length > 20) {  // Assuming max length of 20 characters
          sizeValue = sizeValue.substring(0, 20);
        }
        request.fields['size'] = sizeValue;

        request.fields['first_name'] = firstNameController.text;
        request.fields['last_name'] = lastNameController.text;
        request.fields['job_title'] = jobTitleController.text;
        request.fields['email'] = emailController.text;
        request.fields['password'] = passwordController.text;
        request.fields['password_confirmation'] = confirmPasswordController.text;
        request.fields['preferred_language'] = languageController.text;

        // Optional fields - only add if not empty
        if (websiteController.text.isNotEmpty) {
          request.fields['website'] = websiteController.text;
        }

        if (foundedAtController.text.isNotEmpty) {
          request.fields['founded_at'] = foundedAtController.text;
        }

        // Handle logo - make it null if there's an issue
        if (logoFile != null) {
          try {
            var fileExtension = logoFile!.path.split('.').last.toLowerCase();
            var mimeType = 'image/jpeg'; // Default

            if (fileExtension == 'png') {
              mimeType = 'image/png';
            } else if (fileExtension == 'jpg' || fileExtension == 'jpeg') {
              mimeType = 'image/jpeg';
            }

            request.files.add(await http.MultipartFile.fromPath(
              'org_logo',
              logoFile!.path,
              contentType: MediaType.parse(mimeType),
            ));
          } catch (logoError) {
            debugPrint('‚ùå Logo error: $logoError - continuing without logo');
            // Don't add logo if there's an error - the API will handle null
          }
        } else {
          // Make sure to send null for org_logo by not including it in the request
          debugPrint('‚ÑπÔ∏è No logo selected, sending without logo');
        }

        // Log request details for debugging
        debugPrint('üîç Request URL: ${uri.toString()}');
        debugPrint('üîç Request fields: ${request.fields}');
        debugPrint('üîç Request files: ${request.files.length}');

        // Send request
        var streamedResponse = await request.send();
        var response = await http.Response.fromStream(streamedResponse);
        var responseData = response.body;

        // Log the raw response for debugging
        debugPrint('üìä Status code: ${response.statusCode}');
        debugPrint('üìÑ Response body: $responseData');

        // Try to parse JSON response
        Map<String, dynamic>? jsonResponse;
        try {
          jsonResponse = jsonDecode(responseData);
          debugPrint('‚úÖ JSON parsed: $jsonResponse');
        } catch (jsonError) {
          debugPrint('‚ùå JSON parse error: $jsonError');
        }

        if (response.statusCode == 201 || response.statusCode == 200) {
          // Registration successful
          final token = jsonResponse?['token'];
          debugPrint('‚úÖ Registration successful, token: $token');

          // Show success message
          ScaffoldMessenger.of(context).showSnackBar(
            SnackBar(
              content: Text(jsonResponse?['message'] ?? 'ÿ™ŸÖ ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ ÿ®ŸÜÿ¨ÿßÿ≠'),
              backgroundColor: Colors.green,
            ),
          );

          // Navigate to login screen
          Navigator.pushReplacement(
              context,
              MaterialPageRoute(
                  builder: (_) => const InitiativeOwnerLoginScreen())
          );
        } else {
          // Check if the error response contains a SQL error related to size
          String errorMsg = 'ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ÿ£ÿ´ŸÜÿßÿ° ÿßŸÑÿ™ÿ≥ÿ¨ŸäŸÑ';

          if (jsonResponse != null) {
            if (jsonResponse.containsKey('message') &&
                jsonResponse['message'].toString().contains('Data truncated for column \'size\'')) {
              errorMsg = 'ŸÇŸäŸÖÿ© ÿßŸÑÿ≠ÿ¨ŸÖ ŸÉÿ®Ÿäÿ±ÿ© ÿ¨ÿØŸãÿß. Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÇŸäŸÖÿ© ÿ£ŸÇÿµÿ±.';
            } else if (jsonResponse.containsKey('message')) {
              errorMsg = jsonResponse['message'].toString();
            } else if (jsonResponse.containsKey('error')) {
              errorMsg = jsonResponse['error'].toString();
            } else if (jsonResponse.containsKey('errors')) {
              var errors = jsonResponse['errors'];
              if (errors is Map) {
                if (errors.isNotEmpty) {
                  var firstErrorKey = errors.keys.first;
                  var firstError = errors[firstErrorKey];
                  if (firstError is List && firstError.isNotEmpty) {
                    errorMsg = firstError.first.toString();
                  } else {
                    errorMsg = firstError.toString();
                  }
                }
              } else if (errors is String) {
                errorMsg = errors;
              }
            }
          }

          // Show error in an alert dialog
          showDialog(
            context: context,
            builder: (BuildContext context) {
              return AlertDialog(
                title: const Text('ÿÆÿ∑ÿ£'),
                content: Text(errorMsg),
                actions: [
                  TextButton(
                    child: const Text('ÿ≠ÿ≥ŸÜÿßŸã'),
                    onPressed: () {
                      Navigator.of(context).pop();
                    },
                  ),
                ],
              );
            },
          );
        }
      } catch (e) {
        debugPrint('‚ùå Exception: $e');

        // Show error in an alert dialog
        showDialog(
          context: context,
          builder: (BuildContext context) {
            return AlertDialog(
              title: const Text('ÿÆÿ∑ÿ£'),
              content: Text('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£: ${e.toString()}'),
              actions: [
                TextButton(
                  child: const Text('ÿ≠ÿ≥ŸÜÿßŸã'),
                  onPressed: () {
                    Navigator.of(context).pop();
                  },
                ),
              ],
            );
          },
        );
      } finally {
        setState(() {
          _isLoading = false;
        });
      }
    }
  }
  final List<Map<String, String>> sizeOptions = [
    {'display': 'ÿµÿ∫Ÿäÿ±', 'value': 'small'},
    {'display': 'ŸÖÿ™Ÿàÿ≥ÿ∑', 'value': 'medium'},
    {'display': 'ŸÉÿ®Ÿäÿ±', 'value': 'large'},
  ];

  @override
  Widget build(BuildContext context) {
    return Directionality(
      textDirection: TextDirection.rtl,
      child: Scaffold(
        appBar: AppBar(
            leading: IconButton(
                onPressed: () {
                  Navigator.pushReplacement(
                      context,
                      MaterialPageRoute(builder: (_) => const InitiativeOwnerLoginScreen())
                  );
                },
                icon: const Icon(Icons.arrow_back)
            ),
            centerTitle: true,
            backgroundColor: ColorsManager.primary,
            title: const Text(
              "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿµÿßÿ≠ÿ® ŸÖÿ®ÿßÿØÿ±ÿ©",
              style: TextStyle(
                color: Colors.white,
              ),
            )
        ),
        body: _isLoading
            ? const Center(child: CircularProgressIndicator())
            : SingleChildScrollView(
          padding: const EdgeInsets.all(16.0),
          child: Form(
            key: _formKey,
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                if (_errorMessage != null)
                  Container(
                    padding: const EdgeInsets.all(8),
                    margin: const EdgeInsets.only(bottom: 16),
                    decoration: BoxDecoration(
                      color: Colors.red.shade100,
                      borderRadius: BorderRadius.circular(8),
                      border: Border.all(color: Colors.red),
                    ),
                    child: Text(
                      _errorMessage!,
                      style: const TextStyle(color: Colors.red),
                    ),
                  ),

                // Organization Information Section
                const Text(
                    "ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ©",
                    style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)
                ),
                verticalSpace(16),

                // Organization name
                TextFormField(
                  controller: orgNameController,
                  decoration: InputDecoration(
                    labelText: "ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ© *",
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                    filled: true,
                    fillColor: Colors.grey.shade50,
                  ),
                  validator: (value) => value == null || value.isEmpty
                      ? "Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ©"
                      : null,
                ),
                verticalSpace(12),

                // Country
                TextFormField(
                  controller: countryController,
                  decoration: InputDecoration(
                    labelText: "ÿßŸÑÿØŸàŸÑÿ© *",
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                    filled: true,
                    fillColor: Colors.grey.shade50,
                  ),
                  validator: (value) => value == null || value.isEmpty
                      ? "Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿØŸàŸÑÿ©"
                      : null,
                ),
                verticalSpace(12),

                // City
                TextFormField(
                  controller: cityController,
                  decoration: InputDecoration(
                    labelText: "ÿßŸÑŸÖÿØŸäŸÜÿ© *",
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                    filled: true,
                    fillColor: Colors.grey.shade50,
                  ),
                  validator: (value) => value == null || value.isEmpty
                      ? "Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÖÿØŸäŸÜÿ©"
                      : null,
                ),
                verticalSpace(12),

                // Organization type
                TextFormField(
                  controller: typeController,
                  decoration: InputDecoration(
                    labelText: "ŸÜŸàÿπ ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ© *",
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                    filled: true,
                    fillColor: Colors.grey.shade50,
                  ),
                  validator: (value) => value == null || value.isEmpty
                      ? "Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÜŸàÿπ ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ©"
                      : null,
                ),
                verticalSpace(12),

                // Sector
                TextFormField(
                  controller: sectorController,
                  decoration: InputDecoration(
                    labelText: "ÿßŸÑŸÇÿ∑ÿßÿπ *",
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                    filled: true,
                    fillColor: Colors.grey.shade50,
                  ),
                  validator: (value) => value == null || value.isEmpty
                      ? "Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÇÿ∑ÿßÿπ"
                      : null,
                ),
                verticalSpace(12),


                // Then in your build method
                DropdownButtonFormField<String>(
                  value: sizeController.text.isEmpty ? null : sizeController.text,
                  decoration: InputDecoration(
                    labelText: "ÿßŸÑÿ≠ÿ¨ŸÖ *",
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                    filled: true,
                    fillColor: Colors.grey.shade50,
                  ),
                  items: sizeOptions.map((Map<String, String> option) {
                    return DropdownMenuItem<String>(
                      value: option['value'],
                      child: Text(option['display']!),
                    );
                  }).toList(),
                  onChanged: (newValue) {
                    setState(() {
                      sizeController.text = newValue!;
                    });
                  },
                  validator: (value) => value == null || value.isEmpty
                      ? "Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿ≠ÿ¨ŸÖ ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ©"
                      : null,
                ),
                verticalSpace(12),

                // Website (optional)
                TextFormField(
                  controller: websiteController,
                  decoration: InputDecoration(
                    labelText: "ÿßŸÑŸÖŸàŸÇÿπ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä",
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                    filled: true,
                    fillColor: Colors.grey.shade50,
                  ),
                  keyboardType: TextInputType.url,
                ),
                verticalSpace(12),

                // Founded date (optional)
                TextFormField(
                  controller: foundedAtController,
                  decoration: InputDecoration(
                    labelText: "ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ™ÿ£ÿ≥Ÿäÿ≥",
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                    filled: true,
                    fillColor: Colors.grey.shade50,
                    suffixIcon: IconButton(
                      icon: const Icon(Icons.calendar_today),
                      onPressed: () => _selectDate(context),
                    ),
                  ),
                  readOnly: true,
                ),
                verticalSpace(16),

                // Logo upload
                ElevatedButton.icon(
                  onPressed: _pickLogoImage,
                  icon: const Icon(Icons.image),
                  label: const Text("ÿßÿÆÿ™Ÿäÿßÿ± ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ§ÿ≥ÿ≥ÿ©"),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.grey.shade200,
                    foregroundColor: Colors.black87,
                    padding: const EdgeInsets.symmetric(vertical: 12, horizontal: 16),
                  ),
                ),

                // Show selected logo if any
                if (logoFile != null)
                  Padding(
                    padding: const EdgeInsets.symmetric(vertical: 12),
                    child: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          "ÿßŸÑÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿÆÿ™ÿßÿ±:",
                          style: TextStyle(
                            color: Colors.grey.shade700,
                            fontSize: 14,
                          ),
                        ),
                        const SizedBox(height: 8),
                        ClipRRect(
                          borderRadius: BorderRadius.circular(8),
                          child: Image.file(
                            logoFile!,
                            height: 100,
                            width: 100,
                            fit: BoxFit.cover,
                          ),
                        ),
                      ],
                    ),
                  ),

                const Divider(height: 40),

                // User Information Section
                const Text(
                    "ÿ®ŸäÿßŸÜÿßÿ™ ÿµÿßÿ≠ÿ® ÿßŸÑŸÖÿ®ÿßÿØÿ±ÿ©",
                    style: TextStyle(fontSize: 18, fontWeight: FontWeight.bold)
                ),
                verticalSpace(16),

                // First name
                TextFormField(
                  controller: firstNameController,
                  decoration: InputDecoration(
                    labelText: "ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ£ŸàŸÑ *",
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                    filled: true,
                    fillColor: Colors.grey.shade50,
                  ),
                  validator: (value) => value == null || value.isEmpty
                      ? "Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑÿ£ŸàŸÑ"
                      : null,
                ),
                verticalSpace(12),

                // Last name
                TextFormField(
                  controller: lastNameController,
                  decoration: InputDecoration(
                    labelText: "ÿßÿ≥ŸÖ ÿßŸÑÿπÿßÿ¶ŸÑÿ© *",
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                    filled: true,
                    fillColor: Colors.grey.shade50,
                  ),
                  validator: (value) => value == null || value.isEmpty
                      ? "Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßÿ≥ŸÖ ÿßŸÑÿπÿßÿ¶ŸÑÿ©"
                      : null,
                ),
                verticalSpace(12),

                // Job title
                TextFormField(
                  controller: jobTitleController,
                  decoration: InputDecoration(
                    labelText: "ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä *",
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                    filled: true,
                    fillColor: Colors.grey.shade50,
                  ),
                  validator: (value) => value == null || value.isEmpty
                      ? "Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑŸÖÿ≥ŸÖŸâ ÿßŸÑŸàÿ∏ŸäŸÅŸä"
                      : null,
                ),
                verticalSpace(12),
                // Email
                TextFormField(
                  controller: emailController,
                  decoration: InputDecoration(
                    labelText: "ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä *",
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                    filled: true,
                    fillColor: Colors.grey.shade50,
                  ),
                  keyboardType: TextInputType.emailAddress,
                  validator: (value) {
                    if (value == null || value.isEmpty) {
                      return "Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä";
                    }
                    // Simple email validation
                    if (!value.contains('@') || !value.contains('.')) {
                      return "Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ÿ®ÿ±ŸäÿØ ÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿµÿ≠Ÿäÿ≠";
                    }
                    return null;
                  },
                ),
                verticalSpace(12),

                // Password
                TextFormField(
                  controller: passwordController,
                  decoration: InputDecoration(
                    labelText: "ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± *",
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                    filled: true,
                    fillColor: Colors.grey.shade50,
                  ),
                  obscureText: true,
                  validator: (value) {
                    if (value == null || value.isEmpty) {
                      return "Ÿäÿ±ÿ¨Ÿâ ÿ•ÿØÿÆÿßŸÑ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±";
                    }
                    if (value.length < 6) {
                      return "ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± Ÿäÿ¨ÿ® ÿ£ŸÜ ÿ™ŸÉŸàŸÜ 6 ÿ£ÿ≠ÿ±ŸÅ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ";
                    }
                    return null;
                  },
                ),
                verticalSpace(12),

                // Confirm password
                TextFormField(
                  controller: confirmPasswordController,
                  decoration: InputDecoration(
                    labelText: "ÿ™ÿ£ŸÉŸäÿØ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ± *",
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                    filled: true,
                    fillColor: Colors.grey.shade50,
                  ),
                  obscureText: true,
                  validator: (value) {
                    if (value == null || value.isEmpty) {
                      return "Ÿäÿ±ÿ¨Ÿâ ÿ™ÿ£ŸÉŸäÿØ ŸÉŸÑŸÖÿ© ÿßŸÑŸÖÿ±Ÿàÿ±";
                    }
                    if (value != passwordController.text) {
                      return "ŸÉŸÑŸÖÿßÿ™ ÿßŸÑŸÖÿ±Ÿàÿ± ÿ∫Ÿäÿ± ŸÖÿ™ÿ∑ÿßÿ®ŸÇÿ©";
                    }
                    return null;
                  },
                ),
                verticalSpace(12),

                // Preferred language
                DropdownButtonFormField<String>(
                  value: languageController.text,
                  decoration: InputDecoration(
                    labelText: "ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑŸÖŸÅÿ∂ŸÑÿ© *",
                    border: OutlineInputBorder(
                      borderRadius: BorderRadius.circular(8),
                    ),
                    filled: true,
                    fillColor: Colors.grey.shade50,
                  ),
                  items: languages.map((String language) {
                    return DropdownMenuItem<String>(
                      value: language,
                      child: Text(language),
                    );
                  }).toList(),
                  onChanged: (newValue) {
                    setState(() {
                      languageController.text = newValue!;
                    });
                  },
                  validator: (value) => value == null || value.isEmpty
                      ? "Ÿäÿ±ÿ¨Ÿâ ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©"
                      : null,
                ),
                verticalSpace(32),

                // Submit button
                SizedBox(
                  width: double.infinity,
                  height: 50,
                  child: ElevatedButton(
                    onPressed: _submitForm,
                    style: ElevatedButton.styleFrom(
                      backgroundColor: ColorsManager.primary,
                      foregroundColor: Colors.white,
                      shape: RoundedRectangleBorder(
                        borderRadius: BorderRadius.circular(8),
                      ),
                    ),
                    child: const Text(
                      "ÿ™ÿ≥ÿ¨ŸäŸÑ",
                      style: TextStyle(
                        fontSize: 16,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                  ),
                ),

                verticalSpace(20),

                // Login link
                Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    const Text("ŸÑÿØŸäŸÉ ÿ≠ÿ≥ÿßÿ® ÿ®ÿßŸÑŸÅÿπŸÑÿü"),
                    TextButton(
                      onPressed: () {
                        Navigator.pushReplacement(
                          context,
                          MaterialPageRoute(builder: (_) => const InitiativeOwnerLoginScreen()),
                        );
                      },
                      child: Text(
                        "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",
                        style: TextStyle(
                          color: ColorsManager.primary,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                    ),
                  ],
                ),
                verticalSpace(20),
              ],
            ),
          ),
        ),
      ),
    );
  }
}